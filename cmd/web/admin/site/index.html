<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Oswald">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css"/>
    <link rel="stylesheet" href="tarantula.admin.css"/>
    <script src="tarantula.admin.js"></script>
    <script src="tarantula.html.js"></script>
    <title>iCodeSoftware</title>
    </head>
    <body>
        <div class="w3-display-container w3-teal w3-border-bottom w3-border-red tx-content-120">
            <div class="w3-display-topleft w3-padding">
                <span><i class="material-symbols-outlined tx-margin-left-8 tx-orange-icon-48">widgets</i></span>
            </div>
            <div class="w3-display-topright w3-padding">
                <span id="tx-logout" style="display: none;"><i class="material-symbols-outlined tx-margin-left-8 tx-orange-icon-32">logout</i></span>
            </div>
            <div class="w3-display-bottomleft w3-padding">
               <span class="tx-margin-left-8 tx-text-32">Tarantula Web Admin Tool</span>             
            </div>
            <div class="w3-display-bottomright w3-padding">
               <span class="tx-margin-right-8 tx-text-16">Powered By iCodeSoftware LLC</span>             
            </div>
        </div>
        <div class="w3-flex">
            <div id="tx-task-list" class="w3-padding w3-teal" style="flex-basis:20%;">
            </div>
            <div class="w3-padding w3-white" style="flex-basis:80%;">
                <div class="w3-display-container w3-border w3-border-teal tx-content-48">
                    <div class="w3-display-left w3-padding">
                        <span><i id="tx-task-header-box-icon"  class="material-symbols-outlined tx-margin-top-8 tx-orange-icon-32">doorbell</i></span>
                    </div>
                    <div id="tx-task-header-box-content" class="w3-display-right w3-padding tx-text-20">Wellcome</div>
                </div>
                <div id="tx-info-box" class="w3-display-container w3-border w3-border-red tx-margin-top-8 tx-content-48" style="display: none;">
                    <div class="w3-display-topleft w3-padding">
                        <span><i class="material-symbols-outlined tx-margin-left-8 tx-orange-icon-32">report</i></span>
                    </div>
                    <div class="w3-display-topright w3-padding">
                        <span id="tx-info-box-close"><i class="material-symbols-outlined tx-margin-left-8 tx-red-icon-24">close</i></span>
                    </div>
                    <div id="tx-info-box-content" class="w3-display-middle w3-padding tx-text-12 w3-text-red"></div>
                </div>
                <div id="tx-job-list-box" class="w3-bar w3-border-bottom w3-border-teal tx-margin-top-4" style="display: none"></div> 
                <div id="tx-form-box" class="w3-container tx-margin-top-8" style="display: none"></div>
                <fieldset class="tx-after-login">
                    <legend class="tx-text-16">Categories</legend>
                    <div id="tx-category-list-box" class="w3-bar tx-margin-top-8" style="display: none"></div>
                </fieldset>
                <fieldset class="tx-after-login">
                    <legend class="tx-text-16">Instances</legend>
                    <select id='tx-instance-load-select' class="w3-select tx-text-12">
                        
                    </select>
                    <div id="tx-instance-list-box" class="w3-bar tx-margin-top-8" style="display: none"></div>
                </fieldset>    
            </div>
        </div>
        <script>
            after_login(false)
            Html.eventWithId('#tx-info-box-close',()=>{Html.closeWithId('#tx-info-box');});
            if (!Admin.query().authenticated){
                on_logout();
            }
           
            Html.eventWithId('#tx-logout',()=>{
                Admin.logout();
                Html.closeWithId("#tx-info-box");
                Html.closeWithId("#tx-logout");
                Html.openWithId("#tx-form-box"); 
                Html.messageWithId("#tx-task-list","");
                Html.closeWithId("#tx-job-list-box");
                Html.closeWithId("#tx-category-list-box");
                Html.closeWithId("#tx-instance-list-box");   
                on_logout();
            });

            function on_logout(){
                after_login(false);
                set_task_header("Welcome","doorbell");
                Admin.getJson("/admin/web/login.json",resp=>{
                    let conf ={id:"#tx-form-box",prefix:"login",closeable:false};
                    Html.form(conf,resp,(data)=>{
                        Admin.postJson("/admin/login",data,(resp)=>{
                            if(!resp.successful){
                                Html.messageWithId("#tx-info-box-content",resp.message);    
                                Html.openWithId("#tx-info-box");
                                return;
                            }
                            Html.registerTaskChangeListener(on_task_change);
                            on_login(resp);
                            Html.closeWithId("#tx-info-box");
                            Html.openWithId("#tx-logout");
                            Html.openWithId("#tx-job-list-box");
                            Html.openWithId("#tx-category-list-box");
                            Html.openWithId("#tx-instance-list-box");
                            Html.closeWithId("#tx-form-box");
                        });
                    });
                    Html.openWithId("#tx-form-box");
                });
            }

            function on_login(auth){
                after_login(true);
                Admin.login(auth);
                Admin.getJson("/admin/webprotected/task.list.json",(resp)=>{
                    Html.taskList({id:"#tx-task-list",prefix:"task"},resp,(a)=>{
                        Html.jobList({id:"#tx-job-list-box",prefix:"job"},a,(b)=>{
                            eval(b+"()");
                        });        
                    });
                    Html.jobList({id:"#tx-job-list-box",prefix:"job"},"Asset",(b)=>{
                        eval(b+"()");
                    });
                });
                Admin.getJson("/admin/webprotected/type.list.json",(resp)=>{
                    Html.setup(resp);    
                });
                Admin.getJson("/admin/enum/load/all",resp=>{
                    Html.enumList(resp);
                });

            }

            function create_new_enum(){
                Html.enumForm({id:"#tx-form-box"},(data)=>{
                    let valid = {Name:data.Name,Values:[]};
                    for( let i=0;i<data.ix;i++){
                        if("entry"+i in data){
                            let ev = data["entry"+i];
                            valid.Values.push(ev);
                        }    
                    }
                    Admin.postJson("/admin/enum/save",valid,resp=>{
                        Html.messageWithId("#tx-info-box-content",resp.message);    
                        Html.openWithId("#tx-info-box");
                    });
                });
                Html.openWithId("#tx-form-box");
            }

            function create_new_category(){
                Html.categoryForm({id:"#tx-form-box"},(data)=>{
                    let valid ={Name:data.Name,Description:data.Description,Scope:data.Scope,ScopeSequence:data.ScopeSequence,Properties:[]};
                    for( let i=0;i<data.ix;i++){
                        if("c-entry"+i in data){
                            let ev = data["c-entry"+i];
                            valid.Properties.push(ev);
                        }    
                    }
                    Admin.postJson("/admin/category/save",valid,resp=>{
                        Html.messageWithId("#tx-info-box-content",resp.message);    
                        Html.openWithId("#tx-info-box");
                    });
                });
                Html.openWithId("#tx-form-box");   
            }

            function on_task_change(tsk){
                set_task_header(tsk.Name+":"+tsk.ScopeSequence,tsk.Icon);
                Html.closeWithId("#tx-form-box");
                Html.closeWithId("#tx-instance-list-box");
                Admin.getJson("/admin/category/load/0/scope/1/"+tsk.ScopeSequence,resp=>{
                    Html.typeList(resp);
                    Html.categoryList({id:"#tx-category-list-box",prefix:"cc"},resp,cid=>{
                        load_category(cid);
                    });
                    Html.categorySelect({id:"#tx-instance-load-select"},resp,(c)=>{
                        load_instances(c);
                    });    
                });
                after_login(tsk.ScopeSequence != 0);
            }

            function after_login(open){
                document.querySelectorAll(".tx-after-login").forEach(a=>{
                    if(open){
                        a.style.display = "block";
                    }else{
                        a.style.display = "none";
                    }
                });
            }

            function load_category(cid){
                Admin.getJson("/admin/category/load/"+cid+"/n/0/0",resp=>{
                    Html.instanceForm({id:"#tx-form-box",prefix:"category",closeable:true},resp,data=>{
                        Admin.postJson("/admin/config/save",data,resp=>{
                            Html.messageWithId("#tx-info-box-content",resp.message);    
                            Html.openWithId("#tx-info-box");
                        });
                    },load_categories);
                    Html.openWithId("#tx-form-box");
                });
            }

            function load_instances(cat){
                Html.openWithId("#tx-instance-list-box");
                Admin.getJson("/admin/config/load/0/"+cat+"/10",resp=>{
                    Html.instanceList({id:"#tx-instance-list-box",prefix:"ins"},resp,(id)=>{
                        load_instance(id);
                    });
                });
            }

            function load_instance(id){ 
                Admin.getJson("/admin/config/load/"+id+"/n/0",resp=>{
                    populate_instance(resp);
                });   
            }

            function populate_instance(ins){
                Admin.getJson("/admin/category/load/0/"+ins.ConfigurationCategory+"/0/0",resp=>{
                    Html.instanceForm({id:"#tx-form-box",prefix:"ins"},resp,data=>{
                        Admin.postJson("/admin/config/save",data,resp=>{
                            Html.messageWithId("#tx-info-box-content",resp.message);    
                            Html.openWithId("#tx-info-box");
                        });
                    },load_categories);
                    Html.openWithId("#tx-form-box");
                    Html.populateInstance(ins,load_categories);
                });
            }

            function load_categories(prop,callback){
                Admin.getJson("/admin/config/load/0/"+prop+"/10",cats=>{
                    callback(cats);
                });    
            }

            function set_task_header(tn,icon){
                document.querySelector("#tx-task-header-box-content").innerHTML=tn;
                document.querySelector("#tx-task-header-box-icon").innerHTML=icon;
            }

            function change_password(){
                Admin.getJson("/admin/webprotected/change.password.json",(resp)=>{
                    let conf ={id:"#tx-form-box",prefix:"password",closeable:true};
                    Html.form(conf,resp,(data)=>{
                        Admin.postJson("/admin/password",data,ret=>{
                            Html.messageWithId("#tx-info-box-content",ret.message);    
                            Html.openWithId("#tx-info-box");
                        });    
                    });
                    Html.openWithId("#tx-form-box");
                });
            }

        </script>
    </body>
</html>