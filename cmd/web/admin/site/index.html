<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Oswald">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jsoneditor@10.1.0/dist/jsoneditor.min.css"/>
    <link rel="stylesheet" href="tarantula.admin.css"/>
    <script src="https://cdn.jsdelivr.net/npm/jsoneditor@10.1.0/dist/jsoneditor.min.js"></script>
    <script src="tarantula.admin.js"></script>
    <script src="tarantula.player.js"></script>
    <script src="tarantula.html.js"></script>
    <title>iCodeSoftware</title>
    </head>
    <body>
        <div class="w3-display-container w3-teal w3-border-bottom w3-border-red tx-content-120">
            <div class="w3-display-topleft w3-padding">
                <span><i class="material-symbols-outlined tx-margin-left-8 tx-orange-icon-48">widgets</i></span>
            </div>
            <div class="w3-display-topright w3-padding">
                <span id="tx-logout" style="display: none;"><i class="material-symbols-outlined tx-margin-left-8 tx-orange-icon-32">logout</i></span>
            </div>
            <div class="w3-display-bottomleft w3-padding">
               <span class="tx-margin-left-8 tx-text-32">Tarantula Web Admin Tool</span>             
            </div>
            <div class="w3-display-bottomright w3-padding">
               <span class="tx-margin-right-8 tx-text-16">Powered By iCodeSoftware LLC</span>             
            </div>
        </div>
        <div class="w3-flex">
            <div id="tx-task-list" class="w3-padding w3-teal" style="flex-basis:20%;">
            </div>
            <div class="w3-padding w3-white" style="flex-basis:80%;">
                <div class="w3-display-container w3-border w3-border-teal tx-content-48">
                    <div class="w3-display-left w3-padding">
                        <span><i id="tx-task-header-box-icon"  class="material-symbols-outlined tx-margin-top-8 tx-orange-icon-32">doorbell</i></span>
                    </div>
                    <div id="tx-task-header-box-content" class="w3-display-right w3-padding tx-text-20">Wellcome</div>
                </div>
                <div id="tx-info-box" class="w3-display-container w3-border w3-border-red tx-margin-top-8 tx-content-48" style="display: none;">
                    <div class="w3-display-topleft w3-padding">
                        <span><i class="material-symbols-outlined tx-margin-left-8 tx-orange-icon-32">report</i></span>
                    </div>
                    <div class="w3-display-topright w3-padding">
                        <span id="tx-info-box-close"><i class="material-symbols-outlined tx-margin-left-8 tx-red-icon-24">close</i></span>
                    </div>
                    <div id="tx-info-box-content" class="w3-display-middle w3-padding tx-text-12 w3-text-red"></div>
                </div>
                <div id="tx-job-list-box" class="w3-bar w3-border-bottom w3-border-teal tx-margin-top-4" style="display: none"></div> 
                <div id="tx-form-box" class="w3-container tx-margin-top-8" style="display: none"></div>
                <fieldset class="tx-after-login">
                    <legend class="tx-text-16">Categories</legend>
                    <div id="tx-category-list-box" class="w3-bar tx-margin-top-8" style="display: none"></div>
                </fieldset>
                <fieldset class="tx-after-login">
                    <legend class="tx-text-16">Instances</legend>
                    <select id='tx-instance-load-select' class="w3-select tx-text-12">
                        
                    </select>
                    <div id="tx-instance-list-box" class="w3-bar tx-margin-top-8" style="display: none"></div>
                </fieldset>    
            </div>
        </div>
        <div id="tx-json-preview-box" class="w3-modal w3-animate-zoom tx-hidden">
                <div class="w3-modal-content">
                    <div class="w3-display-container tx-content-64">
                        <div class="w3-display-topright">
                            <span id="tx-json-preview-box-close"><i class="material-symbols-outlined tx-margin-top-8 tx-margin-right-8 tx-red-icon-24">close</i></span>
                        </div>
                        <div class="w3-display-topleft">
                            <span><i class="material-symbols-outlined tx-margin-top-8 tx-margin-left-8 tx-orange-icon-24">preview</i></span>
                        </div>
                        <div id="tx-json-preview-box-title" class="w3-display-middle tx-text-16">content title</div>
                        <div class="w3-display-bottomleft">
                            <span id="tx-json-preview-box-tree" class="w3-tag w3-blue tx-text-12 tx-padding-button tx-margin-left-8">Tree</span>
                            <span id="tx-json-preview-box-code" class="w3-tag w3-blue tx-text-12 tx-padding-button">Code</span>
                            <span id="tx-json-preview-box-preview" class="w3-tag w3-blue tx-text-12 tx-padding-button">Preview</span>
                        </div>
                    </div>
                    <div class="w3-panel" id="tx-json-preview-box-content"></div>
                    <div class="tx-content-24"></div>
                </div>
        </div>
        <div id="tx-edit-confirmation-box" class="w3-modal w3-animate-zoom tx-hidden">
                <div class="w3-modal-content">
                    <div class="w3-display-container tx-content-200">
                        <div class="w3-display-topright">
                            <span id="tx-edit-confirmation-box-close"><i class="material-symbols-outlined tx-margin-top-8 tx-margin-right-8 tx-red-icon-24">close</i></span>
                        </div>
                        <div class="w3-display-topleft">
                            <span><i class="material-symbols-outlined tx-margin-top-8 tx-margin-left-8 tx-orange-icon-48">question_mark</i></span>
                        </div>
                        <div id="tx-edit-confirmation-box-title" class="w3-display-middle tx-text-16">Are you sure to delete item ?</div>
                       
                        <div class="w3-display-bottommiddle">
                            <span id="tx-edit-confirmation-box-confirm" class="w3-tag w3-green tx-text-20 tx-padding-button">Confirm</span>
                        </div>
                    </div>
                    <div class="tx-content-24"></div>
                </div>
        </div>
        <div id="tx-configuration-register-box" class="w3-modal w3-animate-zoom tx-hidden">
                <div class="w3-modal-content">
                    <div class="w3-display-container tx-content-24">
                        <div class="w3-display-topright">
                            <span id="tx-configuration-register-box-close"><i class="material-symbols-outlined tx-margin-top-8 tx-margin-right-8 tx-red-icon-24">close</i></span>
                        </div>
                        <div class="w3-display-topleft">
                            <span><i class="material-symbols-outlined tx-margin-top-8 tx-margin-left-8 tx-orange-icon-32">schedule</i></span>
                        </div>
                    </div>
                    <div class="w3-panel">
                        <fieldset>
                            <legend class="tx-text-20">Register Form</legend>
                            <div class="w3-panel">
                                <p id="tx-configuration-register-box-message" class='tx-text-16'></p>
                            </div>
                            <div class="w3-panel">
                                <select id="tx-configuration-register-box-app" class='w3-round w3-border tx-text-16 w3-select tx-margin-left-4'>
                                </select>
                            </div>
                            <div class="w3-panel"> 
                                <span id="tx-configuration-register" tx-register-id='0' class="w3-tag w3-right w3-green tx-text-20 tx-padding-button tx-hidden">Register</span>
                            </div>
                        </fieldset>
                    </div>
                    <div class="tx-content-24"></div>
                </div>
        </div>
        <div id="tx-popup-form-box" class="w3-modal w3-animate-zoom tx-hidden">
                <div class="w3-modal-content">
                    <div class="w3-display-container tx-content-24">
                        <div class="w3-display-topright">
                            <span id="tx-popup-form-box-close"><i class="material-symbols-outlined tx-margin-top-8 tx-margin-right-8 tx-red-icon-24">close</i></span>
                        </div>
                        <div class="w3-display-topleft">
                            <span><i class="material-symbols-outlined tx-margin-top-8 tx-margin-left-8 tx-orange-icon-32">login</i></span>
                        </div>
                    </div>
                    <div class="w3-panel">
                        <p id="tx-popup-form-box-message" class='w3-center tx-text-16 w3-text-red'></p>
                    </div>
                    <div id="tx-popup-form" class="w3-panel">
                        
                    </div>
                    <div class="tx-content-24"></div>
                </div>
        </div>
        <script>
            let editor;
            after_login(false)
            Html.eventWithId({id:'#tx-info-box-close'},()=>{Html.closeWithId('#tx-info-box');});
            if (!Admin.query().authenticated){
                on_logout();
            }
           
            Html.eventWithId({id:'#tx-logout'},()=>{
                Admin.logout();
                Player.logout();
                Html.closeWithId("#tx-info-box");
                Html.closeWithId("#tx-logout");
                Html.openWithId("#tx-form-box"); 
                Html.messageWithId("#tx-task-list","");
                Html.closeWithId("#tx-job-list-box");
                Html.closeWithId("#tx-category-list-box");
                Html.closeWithId("#tx-instance-list-box");   
                on_logout();
            });

            Html.eventWithId({id:"#tx-json-preview-box-close"},()=>{
                editor.destroy();
                Html.closeWithId("#tx-json-preview-box");
            });
            Html.eventWithId({id:"#tx-json-preview-box-tree"},()=>{
                editor.setMode("tree");
            });
            Html.eventWithId({id:"#tx-json-preview-box-code"},()=>{
                editor.setMode("code");
            });
            Html.eventWithId({id:"#tx-json-preview-box-preview"},()=>{
                editor.setMode("preview");
            });
            Html.eventWithId({id:"#tx-edit-confirmation-box-close"},()=>{
                Html.closeWithId("#tx-edit-confirmation-box");
            }); 
            Html.eventWithId({id:"#tx-edit-confirmation-box-confirm"},()=>{
                Admin.query()["confirm"]();
                Html.closeWithId("#tx-edit-confirmation-box");
            }); 
            Html.eventWithId({id:"#tx-configuration-register-box-close"},()=>{
                Html.closeWithId("#tx-configuration-register-box");
            });
            Html.eventWithId({id:"#tx-popup-form-box-close"},()=>{
                Html.closeWithId("#tx-popup-form-box");
                Html.registerOnError(on_error);
            });
            Html.eventWithId({id:"#tx-configuration-register-box-app",event:"onchange"},()=>{
                let app = document.querySelector("#tx-configuration-register-box-app");
                let sapp = app.options[app.selectedIndex].value;
                console.log(sapp+Admin.query().registerId);
                Admin.getJson("/admin/config/register/load/"+Admin.query().registerId+"/"+sapp,resp=>{
                    console.log(resp);
                    let rct = document.querySelector("#tx-configuration-register");
                    if (resp.Id == "0"){
                        rct.innerHTML = "Register";
                        rct.setAttribute('tx-register-id',0);    
                    }else{
                        rct.innerHTML = "Release";
                        rct.setAttribute('tx-register-id',resp.Id);
                    }
                    rct.style.display = "block";
                });
            });
            Html.eventWithId({id:"#tx-configuration-register"},(te)=>{
                let rid = te.getAttribute('tx-register-id');
                if( rid == "0"){
                    let app = document.querySelector("#tx-configuration-register-box-app");
                    let sapp = app.options[app.selectedIndex].value;
                    let reg ={ItemId:Admin.query().registerId,App:sapp};
                    Admin.postJson("/admin/config/register/save/"+reg.ItemId+"/"+reg.App,reg,(resp)=>{
                        console.log(resp);
                        Html.messageWithId("#tx-configuration-register-box-message",resp.message);
                    });
                    return;
                }
                Admin.getJson("/admin/config/register/delete/"+rid+"/n",(resp)=>{
                        console.log(resp);
                        Html.messageWithId("#tx-configuration-register-box-message",resp.message);
                });
            });

            function on_logout(){
                after_login(false);
                set_task_header("Welcome","doorbell");
                Admin.getJson("/admin/web/login.json",resp=>{
                    let conf ={id:"#tx-form-box",prefix:"login",closeable:false};
                    Html.form(conf,resp,(data)=>{
                        Admin.postJson("/admin/login",data,(resp)=>{
                            if(!resp.successful){
                                Html.messageWithId("#tx-info-box-content",resp.message);    
                                Html.openWithId("#tx-info-box");
                                return;
                            }
                            Html.registerTaskChangeListener(on_task_change);
                            Html.registerUploadTask(on_upload_task);
                            Html.registerOnError(on_error);
                            on_login(resp);
                            Html.closeWithId("#tx-info-box");
                            Html.openWithId("#tx-logout");
                            Html.openWithId("#tx-job-list-box");
                            Html.openWithId("#tx-category-list-box");
                            Html.openWithId("#tx-instance-list-box");
                            Html.closeWithId("#tx-form-box");
                        });
                    });
                    Html.openWithId("#tx-form-box");
                });
            }

            function on_login(auth){
                after_login(true);
                Admin.login(auth);
                Admin.getJson("/admin/webprotected/task.list.json",(resp)=>{
                    Html.taskList({id:"#tx-task-list",prefix:"task"},resp,(a)=>{
                        Html.jobList({id:"#tx-job-list-box",prefix:"job"},a,(b,p)=>{
                            on_job(b,p);
                        });        
                    });
                    Html.jobList({id:"#tx-job-list-box",prefix:"job"},"Asset",(b,p)=>{
                        on_job(b,p);
                    });
                });
                Admin.getJson("/admin/webprotected/type.list.json",(resp)=>{
                    Html.setup(resp);    
                });
                Admin.getJson("/admin/enum/load/all",resp=>{
                    Html.enumList(resp);
                });
            }

            function create_new_enum(){
                Html.enumForm({id:"#tx-form-box"},(data)=>{
                    let valid = {Name:data.Name,Values:[]};
                    for( let i=0;i<data.ix;i++){
                        if("entry"+i in data){
                            let ev = data["entry"+i];
                            valid.Values.push(ev);
                        }    
                    }
                    Admin.postJson("/admin/enum/save",valid,resp=>{
                        Html.messageWithId("#tx-info-box-content",resp.message);    
                        Html.openWithId("#tx-info-box");
                    });
                });
                Html.openWithId("#tx-form-box");
            }

            function create_new_category(){
                Html.categoryForm({id:"#tx-form-box"},(data)=>{
                    let valid ={Name:data.Name,Description:data.Description,Scope:data.Scope,ScopeSequence:data.ScopeSequence,Properties:[]};
                    for( let i=0;i<data.ix;i++){
                        if("c-entry"+i in data){
                            let ev = data["c-entry"+i];
                            valid.Properties.push(ev);
                        }    
                    }
                    Admin.postJson("/admin/category/save",valid,resp=>{
                        Html.messageWithId("#tx-info-box-content",resp.message);    
                        Html.openWithId("#tx-info-box");
                    });
                });
                Html.openWithId("#tx-form-box");   
            }

            function on_task_change(tsk){
                Admin.getJson("/admin/env",resp=>{
                    set_task_header(resp.CurBranch+" : "+tsk.Name,tsk.Icon);
                    set_app_list(resp.ManagedApps);
                });
                Html.closeWithId("#tx-form-box");
                Html.closeWithId("#tx-instance-list-box");
                Html.closeWithId("#tx-info-box");
                Admin.getJson("/admin/category/load/0/scope/"+tsk.ScopeSequence+"/"+tsk.Name,resp=>{
                    Html.typeList(resp);
                    Html.categoryList({id:"#tx-category-list-box",prefix:"cc"},resp,cid=>{
                        load_category(cid);
                    });
                    Html.categorySelect({id:"#tx-instance-load-select"},resp,(c)=>{
                        load_instances(c);
                    });    
                });
                after_login(tsk.ScopeSequence != 0);
                if (tsk.hasOwnProperty("Callback")){
                    let cb = tsk.Callback;
                    if(typeof window[cb] === 'function'){
                        eval(cb+"()");
                    }    
                }
            }

            function after_login(open){
                document.querySelectorAll(".tx-after-login").forEach(a=>{
                    if(open){
                        a.style.display = "block";
                    }else{
                        a.style.display = "none";
                    }
                });
            }

            function load_category(cid){
                Admin.getJson("/admin/category/load/"+cid+"/n/0/n",resp=>{
                    Html.instanceForm({id:"#tx-form-box",prefix:"category",name:"Save",closeable:true},resp,data=>{
                        Admin.postJson("/admin/config/save",data,resp=>{
                            Html.messageWithId("#tx-info-box-content",resp.message);    
                            Html.openWithId("#tx-info-box");
                        });
                    },load_categories);
                    Html.openWithId("#tx-form-box");
                });
            }

            function load_instances(cat){
                Html.openWithId("#tx-instance-list-box");
                Admin.getJson("/admin/config/load/0/"+cat+"/10",resp=>{
                    Html.instanceList({id:"#tx-instance-list-box",prefix:"ins"},resp,(id)=>{
                        load_instance(id);
                    });
                });
            }

            function load_instance(id){ 
                Admin.getJson("/admin/config/load/"+id+"/n/0",resp=>{
                    populate_instance(resp);
                });   
            }

            function populate_instance(ins){
                Admin.getJson("/admin/category/load/0/"+ins.ConfigurationCategory+"/0/n",resp=>{
                    Html.instanceForm({id:"#tx-form-box",prefix:"ins",name:"Upgrade"},resp,data=>{
                        Admin.postJson("/admin/config/save",data,resp=>{
                            Html.messageWithId("#tx-info-box-content",resp.message);    
                            Html.openWithId("#tx-info-box");
                        });
                    },load_categories);
                    Html.openWithId("#tx-form-box");
                    Html.populateInstance(ins,load_categories,(itemId)=>{
                        Admin.query()['confirm']=()=>{
                            Admin.getJson("/admin/item/delete/config/"+itemId,(resp)=>{
                                on_preview("Delete View",resp);
                            }); 
                        };
                        Html.messageWithId("#tx-edit-confirmation-box-title","Are you sure to delete item ["+itemId+"]");
                        Html.openWithId("#tx-edit-confirmation-box");        
                    },(itemId)=>{
                        Admin.query().registerId = itemId;
                        document.querySelector("#tx-configuration-register-box-app").options[0].selected = true;
                        Html.closeWithId("#tx-configuration-register");
                        Html.openWithId("#tx-configuration-register-box");
                    });
                });
            }

            function load_categories(prop,callback){
                Admin.getJson("/admin/config/load/0/"+prop+"/10",cats=>{
                    callback(cats);
                });    
            }

            function set_task_header(tn,icon){
                document.querySelector("#tx-task-header-box-content").innerHTML=tn;
                document.querySelector("#tx-task-header-box-icon").innerHTML=icon;
            }

            function on_upload_task(upload,callback){
                Admin.postJson("/admin/file/save",upload.data,resp=>{
                    Html.messageWithId("#tx-info-box-content",resp.message);    
                    Html.openWithId("#tx-info-box"); 
                    if(resp.successful){
                        callback({file:resp.message});
                    }
                });
            }

            function on_job(job,name){
                if(typeof window[job] === 'function'){
                    Admin.query().job.name = name;
                    eval(job+"()");
                    return;
                }
                Html.messageWithId("#tx-info-box-content","["+job+"] not defined!");    
                Html.openWithId("#tx-info-box"); 
            }


            function on_preview(title,json){
                editor = new JSONEditor(document.querySelector("#tx-json-preview-box-content"),{mode:'tree'},{});
                editor.set(json);
                document.querySelector("#tx-json-preview-box-title").innerHTML=title;
                Html.openWithId("#tx-json-preview-box");    
            }

            function edit_category(){
                let tsk = Html.currentTask();
                Admin.getJson("/admin/category/load/0/scope/"+tsk.ScopeSequence+"/"+tsk.Name,ret=>{
                   Html.editForm({id:"#tx-form-box",prefix:"edit"},ret,(id)=>{
                        on_delete_category(id);
                   },(id)=>{
                        on_preview_category(id); 
                   });
                   Html.openWithId("#tx-form-box");    
                });    
            }
            
            function on_delete_category(cid){
                Admin.query()['confirm']=()=>{
                    Admin.getJson("/admin/item/delete/category/"+cid,(resp)=>{
                        on_preview("Delete View",resp);
                    }); 
                };
                Html.messageWithId("#tx-edit-confirmation-box-title","Are you sure to delete category ["+cid+"]");
                Html.openWithId("#tx-edit-confirmation-box");   
            }

            function on_preview_category(cid){
                Admin.getJson("/admin/category/preview/"+cid,(resp)=>{
                    on_preview("Publish View",resp);
                });    
            }

            function set_app_list(apps){
                let tn = document.querySelector("#tx-configuration-register-box-app");
                tn.innerHTML = "";
                let tem = [];
                tem.push("<option value='' disabled selected>Choose App</option>");
                apps.forEach(a=>{
                    tem.push("<option value='");
                    tem.push(a);
                    tem.push("'>"+Html.caption(a)+"</option>");
                });
                tn.innerHTML = tem.join('');
            }

            function on_error(err){
                Html.messageWithId("#tx-info-box-content",err);    
                Html.openWithId("#tx-info-box");   
            }
            
            function on_post(){
                let job = Html.job(Html.currentTask().Name+"/"+Admin.query().job.name);
                Admin.getJson(job.Form,(resp)=>{
                    let conf ={id:"#tx-form-box",prefix:"admin",closeable:true};
                    Html.form(conf,resp,(data)=>{
                        console.log(data);
                        Admin.postJson(job.Path,data,(resp)=>{
                            on_preview("Post View",resp);
                        });      
                    });
                    Html.openWithId("#tx-form-box");
                });    
            }

            function on_player_login(){
                console.log("player login required");
                if (Player.query().authenticated){
                    return;
                }
                Admin.getJson("/admin/login.json",(resp)=>{
                    let conf ={id:"#tx-popup-form",prefix:"player",closeable:false};
                    Html.form(conf,resp,(data)=>{
                        console.log(data);
                        Player.postJson("/presence/login",data,(resp)=>{
                            Player.login(resp);
                            if (Player.query().authenticated){
                                Html.closeWithId("#tx-popup-form-box");
                            }else{
                                Html.messageWithId("#tx-popup-form-box-message",resp.message)
                            }
                        });      
                    });
                    Html.openWithId("#tx-popup-form-box");
                });
            }
            
            function on_player_post(){
                let job = Html.job(Html.currentTask().Name+"/"+Admin.query().job.name);
                Admin.getJson(job.Form,(resp)=>{
                    let conf ={id:"#tx-form-box",prefix:"player",closeable:true};
                    Html.form(conf,resp,(data)=>{
                        console.log(data);
                        Player.postJson(job.Path,data,(resp)=>{
                            on_preview("Post View",resp);
                            Player.login(resp);
                            console.log(Player.query().token);
                        });      
                    });
                    Html.openWithId("#tx-form-box");
                });    
            }

            function on_player_get(){
                let job = Html.job(Html.currentTask().Name+"/"+Admin.query().job.name);
                Player.getJson(job.Path,(resp)=>{
                    on_preview("Get View",resp);
                });      
            }
        </script>
    </body>
</html>