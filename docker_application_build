# Build
FROM golang:1.24.2-alpine AS builder
ARG app
WORKDIR /build
COPY . .
RUN echo building app : ${app}
RUN mkdir site
RUN if [ ${app} = "admin" ]; then cp -r app/web/${app}/site site; fi
RUN go -C app/web/${app} build -o main 

# Alpine Linux 
FROM alpine:3.21
RUN apk add --no-cache openssh
RUN apk add --no-cache git
ARG app
RUN addgroup -S tarantula && adduser -S tarantula -G tarantula
RUN mkdir /etc/tarantula 
COPY app/web/${app}/${app}-conf.json /etc/tarantula/${app}-conf.json
RUN mkdir /home/tarantula/${app}
RUN mkdir /home/tarantula/.ssh
RUN chown -R tarantula /home/tarantula/.ssh
RUN chown -R tarantula /home/tarantula/${app}   
COPY --from=builder /build/id_ed25519 /home/tarantula/.ssh
COPY --from=builder /build/known_hosts /home/tarantula/.ssh
COPY --from=builder /build/.gitconfig /home/tarantula
RUN chown tarantula /home/tarantula/.ssh/id_ed25519
RUN chown tarantula /home/tarantula/.ssh/known_hosts
RUN chown tarantula /home/tarantula/.gitconfig

USER tarantula
WORKDIR /home/tarantula/.ssh
RUN chmod 700 id_ed25519

# Application Install
WORKDIR /home/tarantula/bin
ARG h
ARG n
ARG s
ARG g
RUN mkdir site
COPY --from=builder /build/app/web/${app}/main .
COPY --from=builder /build/site/* site
RUN git clone git@github.com:yinghu/tarantula.git
WORKDIR /home/tarantula/bin/tarantula
RUN git pull
RUN git checkout ${g}
WORKDIR /home/tarantula/bin
RUN echo ${h} ${n} ${s} ${g}
ENV TN_HOST=${h}
ENV TN_NAME=${n}
ENV TN_ID=${s}
ENV TN_GROUP=${g}
ENTRYPOINT ["./main"]